<script src="//cdn.rawgit.com/noelboss/featherlight/1.3.3/release/featherlight.min.js" type="text/javascript" charset="utf-8"></script>
<script>
var geoList = [];
var virusList = [];
var m = 0;			// page start member
var n = 4;			// page end member
var num = 10;		// number of record in each page
var country = { GU:'Guinea', BE:'Benin', NI:'Nigeria', AO:'Angola', MW:'Malawi', ZM:'Zambia', ZW:'Zimbabwe', TZ:'Tanzania', UG:'Uganda', ET:'Ethiopia', MO:'Mozambique', GH:'Ghana'};

function load_data() {
	$.ajax({
		//url: '{{ dbURL }}',
		url: '/{{ SUB_FDR }}/geo_list/',
		async: false,
		dataType: 'json',
		success: function (data) {
			geoList = data;
		}
	});
}

function load_virus_data() {
	$.ajax({
		//url: '{{ dbURL }}',
		url: '/{{ SUB_FDR }}/virusjson/',
		async: false,
		dataType: 'json',
		success: function (data) {
			virusList = data;
		}
	});
}

/* select virus according to short desc country*/
function virus_selection(virusList, shortName, family) {
	var table_array = [];
	var virus_uniq = {};
	for (var vid in virusList) {
		if ( (virusList[vid]['short'] == shortName && family == 'ALL') || (virusList[vid]['family'] == family && shortName == 'ALL')) {
			for (var i = 0; i< virusList[vid]['sample'].length; i++) {
				var sid = virusList[vid]['sample'][i][0];
				var fid = virusList[vid]['sample'][i][1];
				var cid = sid.substr(0, 2);
				var cname = 'NA';
				if (cid in country) {
					cname = country[cid];
				}

				if (!(sid in virus_uniq)) {
					var table_html = '';
					table_html += "<tr><td>" + cname + "</td>\n";
					table_html += "<td><a href=flist?fid=" + fid + " target=_blank>" + fid + "</a></td>\n";
					table_html += "<td><a href=sinfo?sid=" + sid + " target=_blank>" + sid + "</a></td>\n";
					table_html += "<td>" + virusList[vid]['family'] + "</td>\n";
					table_html += "<td>" + virusList[vid]['short'] + "</td></tr>\n";
					table_array.push(table_html);
					virus_uniq[sid] = sid;
				}
			}
		}
	}
	table_array.sort();
	return table_array;
}

/* select field according to country id */
function field_selection(geoList, cid) {
	var table_array = [];
	for (var name in geoList) {
		var id = name.substr(0,2);
		if (cid == id || cid == 'ALL') {
			var table_html = '';
			var cname = 'NA';
			var lat = parseFloat(geoList[name]['attr'][4]);
			var lng = parseFloat(geoList[name]['attr'][3]);
			if (id in country) { cname = country[id]; }
			table_html += "<tr><td>" + cname + "</td>\n";
			table_html += "<td><a href=flist?fid="+name+">" + name + "</a></td>\n";
			table_html += "<td>" + geoList[name]['attr'][0] + "</td>\n";
			table_html += "<td>" + geoList[name]['attr'][1] + "</td>\n";
			table_html += "<td>" + geoList[name]['attr'][2] + "</td>\n";
			table_html += "<td>" + lat.toFixed(5) + "</td>\n";
			table_html += "<td>" + lng.toFixed(5) + "</td>\n";
			table_html += "<td>" + geoList[name]['attr'][5] + "</td>\n";
			table_html += "<td>" + geoList[name]['attr'][6] + "</td>\n</tr>\n";
			table_array.push(table_html);
		}
	}
	table_array.sort();
	return table_array;
}

/* select sample according to country id */
function sample_selection(geoList, cid) {
	var table_array = [];
	for (var name in geoList) {
		var id = name.substr(0,2);
		if (cid == id || cid == 'ALL') {
			var cname = 'NA';
			if (id in country) { cname = country[id]; }
			var sampleList = geoList[name]['samp'];	
			for(var i = 0; i < sampleList.length; i++) {
				var table_html = '';
				table_html += "<tr><td>" + cname + "</td>\n";
				table_html += "<td><a href=\"sinfo?sid=" + sampleList[i][0] + "\" target=_blank>"+ sampleList[i][0] + "</a></td>\n";
				table_html += "<td>" + sampleList[i][1] + "</td>\n";
				table_html += "<td>" + sampleList[i][2] + "</td>\n";

				if ( sampleList[i][3][0]) {
					table_html += "<td><a href=# data-featherlight=\"/static/images/" + id + "/" + sampleList[i][3][0] + "\">Link</a></td>\n";
				} else {
					table_html += "<td>NA</td>\n";
				}
				if ( sampleList[i][4][0] ) {
					table_html += "<td><a href=# data-featherlight=\"/static/images/" + id + "/" + sampleList[i][4][0] + "\">Link</a></td>\n";
				} else {
					table_html += "<td>NA</td>\n";
				}
				table_html += "<td>" + sampleList[i][5] + "</td>\n";
				table_html += "<td>" + sampleList[i][6] + "</td></tr>\n";
				table_array.push(table_html);
			}
		}
	}
	table_array.sort();
	return table_array;
}
/* pre pagination data */
function pre_pagination(data) {
	var newdata = '';
	for(var i in data) { newdata += data[i]; }
    return newdata;
}

/* pagination for all table html */
function pagination(data, pagetype) {
	var total_page = Math.floor(data.length / num);
	if (data.length % num > 0) {
		total_page += 1;
	}

	if (n < data.length - num && pagetype == 'next') {
		n += num;
		m += num;
		console.log('type');
	}
	else if (m > num && pagetype == 'prev') {
		n -= num;
		m -= num;
	}
	else if (pagetype >= 1 && pagetype <= total_page) {
		m = num*(pagetype-1);
		n = (num*pagetype)-1;
	}
	else {

	}

	// change the pagination html


	var newdata = '';
	for(var i in data) {
		if ( i >= m && i <= n) {
			newdata += data[i];
		}
	}
	return newdata;
}

$(function(){

	/* load all field/sample data with json format */
	load_data();
	load_virus_data();
	
	/* generate selection form for country */
	var sel_org = { GU:'Guinea', BE:'Benin', NI:'Nigeria', AO:'Angola', MW:'Malawi', ZM:'Zambia', ZW:'Zimbabwe', TZ:'Tanzania', UG:'Uganda', ET:'Ethiopia', MO:'Mozambique', GH:'Ghana'}; 
	var sel = {};		// store key and country name
	var sel_sort = [];  // for sorting country
	for (var name in geoList) {
		var id = name.substr(0,2);
		if (!(id in sel)) {
			if (id in sel_org) {
				sel[id] = sel_org[id]
				sel_sort.push(id);
			}
		}
	}
	sel_sort.sort();

	var sel_html = "<option selected value=ALL>All</option>\n";
	for (i=0; i<sel_sort.length; i++) {
		var k = sel_sort[i];
		sel_html += "<option value="+ k + ">" + sel[k] + "</option>\n";
	}
	$( "#fCountry" ).append(sel_html);
	$( "#sCountry" ).append(sel_html);

	/* generate selection form for virus name and family */
	var sel_vname_html = '';
	var sel_vfamily_html = '';
	var sel_vname_uniq = {};
	var sel_vfamily_uniq = {};
	var sname_sort = [];
	var family_sort = [];
	for (var vid in virusList) {
		var sname = virusList[vid]['short'];
		var family = virusList[vid]['family'];
		if (!(sname in sel_vname_uniq)) {
			sname_sort.push(sname);
			sel_vname_uniq[sname] = sname;
		}
		if (!(family in sel_vfamily_uniq)) {
			family_sort.push(family);
			sel_vfamily_uniq[family] = family;
		}
	}

	sname_sort.sort();
	family_sort.sort();

	for(i=0; i<sname_sort.length; i++) {
		var sname = sname_sort[i];
		if (sname == 'Sweet potato leaf curl virus') {
			sel_vname_html = "<option selected value=\""+ sname + "\">" + sname + "</option>\n" + sel_vname_html;
		} else {
			sel_vname_html += "<option value=\""+ sname + "\">" + sname + "</option>\n";
		}
	}

	for(i=0; i<family_sort.length; i++) {
		var family = family_sort[i];
		sel_vfamily_html += "<option value=\""+ family + "\">" + family + "</option>\n";
	}

	$( "#vname" ).append(sel_vname_html);
	$( "#vfamily" ).append(sel_vfamily_html);

	/* display field list */
	var fcountry_id = 'ALL';	// set all for default
	var fcountry_name = 'All';	// set all for default
	var fieldTable = field_selection(geoList, fcountry_id);
	//fieldTablePage = pagination(fieldTable,1)
	var fieldTablePage = pre_pagination(fieldTable);
	$('#fieldTable tbody').html(fieldTablePage);

	$('#fCountry').on('change', function() {
 		fcountry_id = $( "#fCountry" ).val();
		fcountry_name = $( "#fCountry option:selected" ).text();
		fieldTable = field_selection(geoList, fcountry_id);
		fieldTablePage = pre_pagination(fieldTable);
		$('#fieldTable tbody').html(fieldTablePage);
	});

	/* pagination action for field
	$('#fnext').on('click', function() {
		fieldTablePage = pagination(fieldTable,'next')
		$('#fieldTable tbody').html(fieldTablePage);
	});

	$('#fprev').on('click', function() {
		fieldTablePage = pagination(fieldTable,'prev')
		$('#fieldTable tbody').html(fieldTablePage);
	});
	*/

	/* display sample list */
	var scountry_id = 'ALL';    // set all for default
	var scountry_name = 'All';  // set all for default
	var sampleTable = sample_selection(geoList, scountry_id);
	var sampleTablePage = pre_pagination(sampleTable);
	$('#sampleTable tbody').html(sampleTablePage);

	$('#sCountry').on('change', function() {
        scountry_id = $( "#sCountry" ).val();
        scountry_name = $( "#sCountry option:selected" ).text();
        sampleTable = sample_selection(geoList, scountry_id);
		sampleTablePage = pre_pagination(sampleTable);
        $('#sampleTable tbody').html(sampleTablePage);
    });

	/* display virus list */
	var virus_name = $( "#vname" ).val();
	var virus_family = 'ALL';
	var virusTable = virus_selection(virusList, virus_name, virus_family);
	var virusTablePage = pre_pagination(virusTable);
	$('#virusTable tbody').append(virusTablePage);	
	
	$('#vname').on('change', function() {
        virus_name = $( "#vname" ).val();
		virus_family = 'ALL';
        virusTable = virus_selection(virusList, virus_name, virus_family);
		virusTablePage = pre_pagination(virusTable);
        $('#virusTable tbody').html('');
        $('#virusTable tbody').append(virusTablePage);
    });

	$('#vfamily').on('change', function() {
        virus_name = 'ALL';
        virus_family = $( "#vfamily" ).val();
        virusTable = virus_selection(virusList, virus_name, virus_family);
        $('#virusTable tbody').html('');
        $('#virusTable tbody').append(virusTable);
    });

	$('#vnext').on('click', function() {
		console.log("action next");
        //virusTable = virus_selection(virusList, virus_name, virus_family);
        //$('#virusTable tbody').html('');
        //$('#virusTable tbody').append(virusTable);
    });

	/* change of tab, !!! will be used for map function */
	// $('#fieldTabLink').on('shown.bs.tab', function(e) {});
	// $('#sampleTabLink').on('shown.bs.tab', function(e) {});
	// $('#virusTabLink').on('shown.bs.tab', function(e) {});
});

</script>
