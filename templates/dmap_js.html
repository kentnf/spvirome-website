<script src="http://maps.googleapis.com/maps/api/js?key=AIzaSyAs8XAvF2CLHMosa7W2126k2qDfEonb6OQ&sensor=false"></script>
<script>
      var script = '<script type="text/javascript" src="/js/markerclusterer';
      if (document.location.search.indexOf('compiled') !== -1) {
        script += '_compiled';
      }
      script += '.js"><' + '/script>';
      document.write(script);
</script>
<script>

var geoList = [];
var virusList = [];

function load_data() {
	$.ajax({
		//url: '{{ dbURL }}',
		url: '/{{ SUB_FDR }}/geo_list/',
		async: false,
		dataType: 'json',
		success: function (data) {
			geoList = data;
		}
	});
}

function load_virus_data() {
    $.ajax({
        //url: '{{ dbURL }}',
        url: '/{{ SUB_FDR }}/virusjson/',
        async: false,
        dataType: 'json',
        success: function (data) {
            virusList = data;
        }
    });
}

// initialize map for field/sample
function initialize() {
	var myCenter=new google.maps.LatLng(0,18);
	var mapProp = {
		center:myCenter,
		zoom:3,
		mapTypeId:google.maps.MapTypeId.ROADMAP
	};
	        	
	var map=new google.maps.Map(document.getElementById("fieldMap"),mapProp);
	//var markers = [];
	var markers = setMarkers(map, geoList);
	var markerCluster = new MarkerClusterer(map, markers);
}

// initialize map for virus
function initialize_virus_map() {
	var myCenter=new google.maps.LatLng(0,18);
	var mapProp = {
		center:myCenter,
		zoom:3,
		mapTypeId:google.maps.MapTypeId.ROADMAP
	};

	var map=new google.maps.Map(document.getElementById("virusMap"),mapProp);
	var markers = setVirusMarkers(map, virusList); 
	var markerClutser = new MarkerClusterer(map, markers);
}

// set virus markers
function setVirusMarkers(map, virusList) {
	var markers = [];
	var gps_uniq = {};
	for (var vid in virusList) {
		for (var i in virusList[vid]['sample']) {
			var fid = virusList[vid]['sample'][i][1];
			var lat = virusList[vid]['sample'][i][2];
			var lng = virusList[vid]['sample'][i][3];

			if (!(fid in gps_uniq)) {
				gps_uniq[fid] = fid;
				var latlngset = new google.maps.LatLng(lat, lng);
				var marker = new google.maps.Marker({
					map: map,
					title: fid,
					position: latlngset
				});
				markers.push(marker);
				marker.setMap(map);
			}
		}	
	}
	return markers;
}

// set field markers
var prev_infowindow = false; 

function setMarkers(map, geoList){
	var marker;
	var markers = [];
	for (var name in geoList) {
		var lat = geoList[name]['attr'][4];
		var lng = geoList[name]['attr'][3];
		var latlngset = new google.maps.LatLng(lat, lng);
 		var marker = new google.maps.Marker({  
          	map: map, 
			title: name, 
			position: latlngset
        	});
		markers.push(marker);
        marker.setMap(map);

		// code for display field info in infowindow
		var fieldInfo = "Field ID: <a href=flist?fid="+name+">"+name+"</a>";
			fieldInfo += "<br />Region: " + geoList[name]['attr'][0];
			fieldInfo += "<br />District: " + geoList[name]['attr'][1];
			fieldInfo += "<br />Locality: " + geoList[name]['attr'][2];
			fieldInfo += "<br />Size: " + geoList[name]['attr'][5];

		var sampleList = geoList[name]['samp'];
		google.maps.event.addListener(marker,'click', (function(marker, fieldInfo, sampleList){ 
        			return function() {
					if (prev_infowindow) {
						prev_infowindow.close();
					}	
					var infowindow = new google.maps.InfoWindow({ content: fieldInfo});
					infowindow.open(map,marker);
					prev_infowindow = infowindow;
					
					// code for showing sample list
					var sampleTable = "";
					for(var i = 0; i < sampleList.length; i++) {
						sampleTable += "<p>Sample ID:" + sampleList[i][0];
						sampleTable += "<br />Cultivar:" + sampleList[i][6];
						sampleTable += "<br />Intercrop:" + sampleList[i][5];
						sampleTable += "<br />Date:" + sampleList[i][1];
						sampleTable += "<br />Age:" + sampleList[i][2];
						sampleTable += "<br />Image:" + sampleList[i][3];
						sampleTable += "<br />Leave:" + sampleList[i][4];
						sampleTable += "</p>";
					}
					$("#sampleTab").html(sampleTable);
					$("#fieldInfo").html(fieldInfo);
        			};
    	})(marker,fieldInfo, sampleList)); 
	}
	return markers;
}

$(function() {
	/* Load field/sample GPS and virus related GPS */
	load_data();
	load_virus_data();
	google.maps.event.addDomListener(window, 'load', initialize);

	/* Filter the dataset by virus type (Control by name List)*/

	// action for tab of virus map
	var map;
    $('#virusMapLink').on('shown.bs.tab', function(e) {
        if( map == undefined) {
			initialize_virus_map();
        }
    });
})

</script>
